//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package optimize ;import (_ed "bytes";_c "crypto/md5";_aa "errors";_f "fmt";_d "github.com/unidoc/unipdf/v4/common";_fd "github.com/unidoc/unipdf/v4/contentstream";_fc "github.com/unidoc/unipdf/v4/core";_dd "github.com/unidoc/unipdf/v4/extractor";_db "github.com/unidoc/unipdf/v4/internal/imageutil";
_dg "github.com/unidoc/unipdf/v4/internal/textencoding";_dga "github.com/unidoc/unipdf/v4/model";_g "github.com/unidoc/unitype";_a "golang.org/x/image/draw";_e "math";_af "strings";);

// CleanContentstream cleans up redundant operands in content streams, including Page and XObject Form
// contents. This process includes:
// 1. Marked content operators are removed.
// 2. Some operands are simplified (shorter form).
// TODO: Add more reduction methods and improving the methods for identifying unnecessary operands.
type CleanContentstream struct{};

// Optimize optimizes PDF objects to decrease PDF size.
func (_ddca *ObjectStreams )Optimize (objects []_fc .PdfObject )(_bdbb []_fc .PdfObject ,_fced error ){_fcd :=&_fc .PdfObjectStreams {};_fdba :=make ([]_fc .PdfObject ,0,len (objects ));for _ ,_bbg :=range objects {if _fgfd ,_daeg :=_bbg .(*_fc .PdfIndirectObject );
_daeg &&_fgfd .GenerationNumber ==0{_fcd .Append (_bbg );}else {_fdba =append (_fdba ,_bbg );};};if _fcd .Len ()==0{return _fdba ,nil ;};_bdbb =make ([]_fc .PdfObject ,0,len (_fdba )+_fcd .Len ()+1);if _fcd .Len ()> 1{_bdbb =append (_bdbb ,_fcd );};_bdbb =append (_bdbb ,_fcd .Elements ()...);
_bdbb =append (_bdbb ,_fdba ...);return _bdbb ,nil ;};func _eg (_gce *_fc .PdfObjectStream )error {_ab ,_gf :=_fc .DecodeStream (_gce );if _gf !=nil {return _gf ;};_ag :=_fd .NewContentStreamParser (string (_ab ));_ddg ,_gf :=_ag .Parse ();if _gf !=nil {return _gf ;
};_ddg =_edd (_ddg );_fg :=_ddg .Bytes ();if len (_fg )>=len (_ab ){return nil ;};_bd ,_gf :=_fc .MakeStream (_ddg .Bytes (),_fc .NewFlateEncoder ());if _gf !=nil {return _gf ;};_gce .Stream =_bd .Stream ;_gce .Merge (_bd .PdfObjectDictionary );return nil ;
};

// CombineIdenticalIndirectObjects combines identical indirect objects.
// It implements interface model.Optimizer.
type CombineIdenticalIndirectObjects struct{};

// Optimize optimizes PDF objects to decrease PDF size.
func (_baa *CleanFonts )Optimize (objects []_fc .PdfObject )(_cfe []_fc .PdfObject ,_ffg error ){var _aee map[*_fc .PdfObjectStream ]struct{};if _baa .Subset {var _dee error ;_aee ,_dee =_bdb (objects );if _dee !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004fR\u003a\u0020\u0046\u0061\u0069\u006c\u0065\u0064\u0020\u0073u\u0062s\u0065\u0074\u0074\u0069\u006e\u0067\u003a \u0025\u0076",_dee );
return nil ,_dee ;};};for _ ,_fad :=range objects {_cgb ,_feb :=_fc .GetStream (_fad );if !_feb {continue ;};if _ ,_ecfb :=_aee [_cgb ];_ecfb {continue ;};_caf ,_eac :=_fc .NewEncoderFromStream (_cgb );if _eac !=nil {_d .Log .Debug ("\u0045\u0052RO\u0052\u0020\u0067e\u0074\u0074\u0069\u006eg e\u006eco\u0064\u0065\u0072\u003a\u0020\u0025\u0076 -\u0020\u0069\u0067\u006e\u006f\u0072\u0069n\u0067",_eac );
continue ;};_fed ,_eac :=_caf .DecodeStream (_cgb );if _eac !=nil {_d .Log .Debug ("\u0044\u0065\u0063\u006f\u0064\u0069\u006e\u0067\u0020\u0065r\u0072\u006f\u0072\u0020\u003a\u0020\u0025v\u0020\u002d\u0020\u0069\u0067\u006e\u006f\u0072\u0069\u006e\u0067",_eac );
continue ;};if len (_fed )< 4{continue ;};_bdag :=string (_fed [:4]);if _bdag =="\u004f\u0054\u0054\u004f"{continue ;};if _bdag !="\u0000\u0001\u0000\u0000"&&_bdag !="\u0074\u0072\u0075\u0065"{continue ;};_ffb ,_eac :=_g .Parse (_ed .NewReader (_fed ));
if _eac !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u0020P\u0061\u0072\u0073\u0069\u006e\u0067\u0020\u0066\u006f\u006e\u0074\u003a\u0020%\u0076\u0020\u002d\u0020\u0069\u0067\u006eo\u0072\u0069\u006e\u0067",_eac );continue ;};_eac =_ffb .Optimize ();
if _eac !=nil {_d .Log .Debug ("\u0045\u0052RO\u0052\u0020\u004fp\u0074\u0069\u006d\u0069zin\u0067 f\u006f\u006e\u0074\u003a\u0020\u0025\u0076 -\u0020\u0073\u006b\u0069\u0070\u0070\u0069n\u0067",_eac );continue ;};var _ecc _ed .Buffer ;_eac =_ffb .Write (&_ecc );
if _eac !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u0020W\u0072\u0069\u0074\u0069\u006e\u0067\u0020\u0066\u006f\u006e\u0074\u003a\u0020%\u0076\u0020\u002d\u0020\u0069\u0067\u006eo\u0072\u0069\u006e\u0067",_eac );continue ;};if _ecc .Len ()> len (_fed ){_d .Log .Debug ("\u0052\u0065-\u0077\u0072\u0069\u0074\u0074\u0065\u006e\u0020\u0066\u006f\u006e\u0074\u0020\u0069\u0073\u0020\u006c\u0061\u0072\u0067\u0065\u0072\u0020\u0074\u0068\u0061\u006e\u0020\u006f\u0072\u0069\u0067\u0069\u006e\u0061\u006c\u0020\u002d\u0020\u0073\u006b\u0069\u0070");
continue ;};_edc ,_eac :=_fc .MakeStream (_ecc .Bytes (),_fc .NewFlateEncoder ());if _eac !=nil {continue ;};*_cgb =*_edc ;_cgb .Set ("\u004ce\u006e\u0067\u0074\u0068\u0031",_fc .MakeInteger (int64 (_ecc .Len ())));};return objects ,nil ;};

// Optimize implements Optimizer interface.
func (_ega *CleanUnusedResources )Optimize (objects []_fc .PdfObject )(_aac []_fc .PdfObject ,_ccf error ){_fdg ,_ccf :=_ebb (objects );if _ccf !=nil {return nil ,_ccf ;};_bcd :=[]_fc .PdfObject {};for _ ,_fddb :=range objects {_ ,_fca :=_fdg [_fddb ];
if _fca {continue ;};_bcd =append (_bcd ,_fddb );};return _bcd ,nil ;};

// Options describes PDF optimization parameters.
type Options struct{CombineDuplicateStreams bool ;CombineDuplicateDirectObjects bool ;ImageUpperPPI float64 ;ImageQuality int ;UseObjectStreams bool ;CombineIdenticalIndirectObjects bool ;CompressStreams bool ;CleanFonts bool ;SubsetFonts bool ;CleanContentstream bool ;
CleanUnusedResources bool ;};func _dfde (_ddaf _fc .PdfObject )(string ,error ){_dgf :=_fc .TraceToDirectObject (_ddaf );switch _bfcg :=_dgf .(type ){case *_fc .PdfObjectString :return _bfcg .Str (),nil ;case *_fc .PdfObjectStream :_bfd ,_bga :=_fc .DecodeStream (_bfcg );
if _bga !=nil {return "",_bga ;};return string (_bfd ),nil ;};return "",_f .Errorf ("\u0069\u006e\u0076\u0061\u006ci\u0064\u0020\u0063\u006f\u006e\u0074\u0065\u006e\u0074\u0020\u0073\u0074\u0072e\u0061\u006d\u0020\u006f\u0062\u006a\u0065\u0063\u0074\u0020\u0068\u006f\u006c\u0064\u0065\u0072\u0020\u0028\u0025\u0054\u0029",_dgf );
};func _bdb (_egd []_fc .PdfObject )(_ad map[*_fc .PdfObjectStream ]struct{},_cfg error ){_ad =map[*_fc .PdfObjectStream ]struct{}{};_cdg :=map[*_dga .PdfFont ]struct{}{};_cacf :=_bfec (_egd );for _ ,_bfg :=range _cacf ._agfd {_gg ,_gfa :=_fc .GetDict (_bfg .PdfObject );
if !_gfa {continue ;};_ggc ,_gfa :=_fc .GetDict (_gg .Get ("\u0052e\u0073\u006f\u0075\u0072\u0063\u0065s"));if !_gfa {continue ;};_ggd ,_ :=_caae (_gg .Get ("\u0043\u006f\u006e\u0074\u0065\u006e\u0074\u0073"));_eae ,_fab :=_dga .NewPdfPageResourcesFromDict (_ggc );
if _fab !=nil {return nil ,_fab ;};_ce :=[]content {{_bdac :_ggd ,_gac :_eae }};_ada :=_age (_gg .Get ("\u0041\u006e\u006e\u006f\u0074\u0073"));if _ada !=nil {_ce =append (_ce ,_ada ...);};for _ ,_baf :=range _ce {_gbd ,_cg :=_dd .NewFromContents (_baf ._bdac ,_baf ._gac );
if _cg !=nil {return nil ,_cg ;};_agc ,_ ,_ ,_cg :=_gbd .ExtractPageText ();if _cg !=nil {return nil ,_cg ;};for _ ,_bbf :=range _agc .Marks ().Elements (){if _bbf .Font ==nil {continue ;};if _ ,_caa :=_cdg [_bbf .Font ];!_caa {_cdg [_bbf .Font ]=struct{}{};
};};};};_cfd :=map[*_fc .PdfObjectStream ][]*_dga .PdfFont {};for _fbg :=range _cdg {_fgc :=_fbg .FontDescriptor ();if _fgc ==nil ||_fgc .FontFile2 ==nil {continue ;};_dde ,_fea :=_fc .GetStream (_fgc .FontFile2 );if !_fea {continue ;};_cfd [_dde ]=append (_cfd [_dde ],_fbg );
};for _bbe :=range _cfd {var _dbd []rune ;var _gbb []_g .GlyphIndex ;for _ ,_gdd :=range _cfd [_bbe ]{switch _ggf :=_gdd .Encoder ().(type ){case *_dg .IdentityEncoder :_dac :=_ggf .RegisteredRunes ();_bag :=make ([]_g .GlyphIndex ,len (_dac ));for _ecfd ,_aaf :=range _dac {_bag [_ecfd ]=_g .GlyphIndex (_aaf );
};_gbb =append (_gbb ,_bag ...);case *_dg .TrueTypeFontEncoder :_cgc :=_ggf .RegisteredRunes ();_dbd =append (_dbd ,_cgc ...);case _dg .SimpleEncoder :_gbe :=_ggf .Charcodes ();for _ ,_egc :=range _gbe {_ffc ,_bbff :=_ggf .CharcodeToRune (_egc );if !_bbff {_d .Log .Debug ("\u0043\u0068a\u0072\u0063\u006f\u0064\u0065\u003c\u002d\u003e\u0072\u0075\u006e\u0065\u0020\u006e\u006f\u0074\u0020\u0066\u006f\u0075\u006e\u0064: \u0025\u0064",_egc );
continue ;};_dbd =append (_dbd ,_ffc );};};};_cfg =_abc (_bbe ,_dbd ,_gbb );if _cfg !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u0020\u0073\u0075\u0062\u0073\u0065\u0074\u0074\u0069\u006eg\u0020f\u006f\u006e\u0074\u0020\u0073\u0074\u0072\u0065\u0061\u006d\u003a\u0020\u0025\u0076",_cfg );
return nil ,_cfg ;};_ad [_bbe ]=struct{}{};};return _ad ,nil ;};func _eacd (_cbb []*_fc .PdfIndirectObject )map[string ][]string {_bcf :=map[string ][]string {};for _ ,_bbfb :=range _cbb {_bfcc ,_fcf :=_fc .GetDict (_bbfb .PdfObject );if !_fcf {continue ;
};_fbe :=_bfcc .Get ("\u0043\u006f\u006e\u0074\u0065\u006e\u0074\u0073");_fedb :=_fc .TraceToDirectObject (_fbe );_cafc :="";if _ffe ,_dcc :=_fedb .(*_fc .PdfObjectArray );_dcc {var _egdg []string ;for _ ,_dfb :=range _ffe .Elements (){_fda ,_aad :=_dfde (_dfb );
if _aad !=nil {continue ;};_egdg =append (_egdg ,_fda );};_cafc =_af .Join (_egdg ,"\u0020");};if _gddc ,_cfaf :=_fedb .(*_fc .PdfObjectStream );_cfaf {_eaea ,_gagg :=_fc .DecodeStream (_gddc );if _gagg !=nil {continue ;};_cafc =string (_eaea );};_edfe :=_fd .NewContentStreamParser (_cafc );
_gcc ,_bdgb :=_edfe .Parse ();if _bdgb !=nil {continue ;};for _ ,_cgf :=range *_gcc {_ddga :=_cgf .Operand ;_gbc :=_cgf .Params ;switch _ddga {case "\u0044\u006f":_efag :=_gbc [0].String ();if _ ,_bfgd :=_bcf ["\u0058O\u0062\u006a\u0065\u0063\u0074"];!_bfgd {_bcf ["\u0058O\u0062\u006a\u0065\u0063\u0074"]=[]string {_efag };
}else {_bcf ["\u0058O\u0062\u006a\u0065\u0063\u0074"]=append (_bcf ["\u0058O\u0062\u006a\u0065\u0063\u0074"],_efag );};case "\u0054\u0066":_cba :=_gbc [0].String ();if _ ,_bdbg :=_bcf ["\u0046\u006f\u006e\u0074"];!_bdbg {_bcf ["\u0046\u006f\u006e\u0074"]=[]string {_cba };
}else {_bcf ["\u0046\u006f\u006e\u0074"]=append (_bcf ["\u0046\u006f\u006e\u0074"],_cba );};case "\u0067\u0073":_ggcg :=_gbc [0].String ();if _ ,_deca :=_bcf ["\u0045x\u0074\u0047\u0053\u0074\u0061\u0074e"];!_deca {_bcf ["\u0045x\u0074\u0047\u0053\u0074\u0061\u0074e"]=[]string {_ggcg };
}else {_bcf ["\u0045x\u0074\u0047\u0053\u0074\u0061\u0074e"]=append (_bcf ["\u0045x\u0074\u0047\u0053\u0074\u0061\u0074e"],_ggcg );};};};};return _bcf ;};type imageModifications struct{Scale float64 ;Encoding _fc .StreamEncoder ;};

// New creates a optimizers chain from options.
func New (options Options )*Chain {_bcea :=new (Chain );if options .CleanFonts ||options .SubsetFonts {_bcea .Append (&CleanFonts {Subset :options .SubsetFonts });};if options .CleanContentstream {_bcea .Append (new (CleanContentstream ));};if options .ImageUpperPPI > 0{_dcfg :=new (ImagePPI );
_dcfg .ImageUpperPPI =options .ImageUpperPPI ;_bcea .Append (_dcfg );};if options .ImageQuality > 0{_baab :=new (Image );_baab .ImageQuality =options .ImageQuality ;_bcea .Append (_baab );};if options .CombineDuplicateDirectObjects {_bcea .Append (new (CombineDuplicateDirectObjects ));
};if options .CombineDuplicateStreams {_bcea .Append (new (CombineDuplicateStreams ));};if options .CombineIdenticalIndirectObjects {_bcea .Append (new (CombineIdenticalIndirectObjects ));};if options .UseObjectStreams {_bcea .Append (new (ObjectStreams ));
};if options .CompressStreams {_bcea .Append (new (CompressStreams ));};if options .CleanUnusedResources {_bcea .Append (new (CleanUnusedResources ));};return _bcea ;};

// ImagePPI optimizes images by scaling images such that the PPI (pixels per inch) is never higher than ImageUpperPPI.
// TODO(a5i): Add support for inline images.
// It implements interface model.Optimizer.
type ImagePPI struct{ImageUpperPPI float64 ;};func _edd (_ec *_fd .ContentStreamOperations )*_fd .ContentStreamOperations {if _ec ==nil {return nil ;};_gc :=_fd .ContentStreamOperations {};for _ ,_gd :=range *_ec {switch _gd .Operand {case "\u0042\u0044\u0043","\u0042\u004d\u0043","\u0045\u004d\u0043":continue ;
case "\u0054\u006d":if len (_gd .Params )==6{if _ddae ,_gag :=_fc .GetNumbersAsFloat (_gd .Params );_gag ==nil {if _ddae [0]==1&&_ddae [1]==0&&_ddae [2]==0&&_ddae [3]==1{_gd =&_fd .ContentStreamOperation {Params :[]_fc .PdfObject {_gd .Params [4],_gd .Params [5]},Operand :"\u0054\u0064"};
};};};};_gc =append (_gc ,_gd );};return &_gc ;};func _adgb (_cbf _fc .PdfObject ,_abe map[_fc .PdfObject ]struct{})error {if _fbac ,_eaa :=_cbf .(*_fc .PdfIndirectObject );_eaa {_abe [_cbf ]=struct{}{};_gdc :=_adgb (_fbac .PdfObject ,_abe );if _gdc !=nil {return _gdc ;
};return nil ;};if _ddb ,_eef :=_cbf .(*_fc .PdfObjectStream );_eef {_abe [_ddb ]=struct{}{};_aabb :=_adgb (_ddb .PdfObjectDictionary ,_abe );if _aabb !=nil {return _aabb ;};return nil ;};if _ebc ,_bdd :=_cbf .(*_fc .PdfObjectDictionary );_bdd {for _ ,_cfbb :=range _ebc .Keys (){_cdgg :=_ebc .Get (_cfbb );
_ =_cdgg ;if _egg ,_cfdf :=_cdgg .(*_fc .PdfObjectReference );_cfdf {_cdgg =_egg .Resolve ();_ebc .Set (_cfbb ,_cdgg );};if _cfbb !="\u0050\u0061\u0072\u0065\u006e\u0074"{if _egb :=_adgb (_cdgg ,_abe );_egb !=nil {return _egb ;};};};return nil ;};if _acg ,_ddaa :=_cbf .(*_fc .PdfObjectArray );
_ddaa {if _acg ==nil {return _aa .New ("\u0061\u0072\u0072a\u0079\u0020\u0069\u0073\u0020\u006e\u0069\u006c");};for _cfc ,_gage :=range _acg .Elements (){if _ceg ,_abf :=_gage .(*_fc .PdfObjectReference );_abf {_gage =_ceg .Resolve ();_acg .Set (_cfc ,_gage );
};if _bfac :=_adgb (_gage ,_abe );_bfac !=nil {return _bfac ;};};return nil ;};return nil ;};

// Optimize optimizes PDF objects to decrease PDF size.
func (_eaab *CombineIdenticalIndirectObjects )Optimize (objects []_fc .PdfObject )(_cbe []_fc .PdfObject ,_cgd error ){_fgfg (objects );_aadd :=make (map[_fc .PdfObject ]_fc .PdfObject );_feg :=make (map[_fc .PdfObject ]struct{});_daa :=make (map[string ][]*_fc .PdfIndirectObject );
for _ ,_cec :=range objects {_ecbd ,_bfge :=_cec .(*_fc .PdfIndirectObject );if !_bfge {continue ;};if _fccb ,_ddc :=_ecbd .PdfObject .(*_fc .PdfObjectDictionary );_ddc {if _ccb ,_acc :=_fccb .Get ("\u0054\u0079\u0070\u0065").(*_fc .PdfObjectName );_acc &&*_ccb =="\u0050\u0061\u0067\u0065"{continue ;
};if _afc :=_fccb .Keys ();len (_afc )==0{continue ;};_egf :=_c .New ();_egf .Write (_fccb .Write ());_ebag :=string (_egf .Sum (nil ));_daa [_ebag ]=append (_daa [_ebag ],_ecbd );};};for _ ,_cfge :=range _daa {if len (_cfge )< 2{continue ;};_cgcf :=_cfge [0];
for _ceb :=1;_ceb < len (_cfge );_ceb ++{_dgc :=_cfge [_ceb ];_aadd [_dgc ]=_cgcf ;_feg [_dgc ]=struct{}{};};};_cbe =make ([]_fc .PdfObject ,0,len (objects )-len (_feg ));for _ ,_cbg :=range objects {if _ ,_geba :=_feg [_cbg ];_geba {continue ;};_cbe =append (_cbe ,_cbg );
};_dea (_cbe ,_aadd );return _cbe ,nil ;};

// CleanUnusedResources represents an optimizer used to clean unused resources.
type CleanUnusedResources struct{};

// CleanFonts cleans up embedded fonts, reducing font sizes.
type CleanFonts struct{

// Subset embedded fonts if encountered (if true).
// Otherwise attempts to reduce the font program.
Subset bool ;};type imageInfo struct{BitsPerComponent int ;ColorComponents int ;Width int ;Height int ;Stream *_fc .PdfObjectStream ;PPI float64 ;};

// Optimize optimizes PDF objects to decrease PDF size.
func (_ea *CleanContentstream )Optimize (objects []_fc .PdfObject )(_cf []_fc .PdfObject ,_abb error ){_bc :=map[*_fc .PdfObjectStream ]struct{}{};var _fge []*_fc .PdfObjectStream ;_ff :=func (_fe *_fc .PdfObjectStream ){if _ ,_edf :=_bc [_fe ];!_edf {_bc [_fe ]=struct{}{};
_fge =append (_fge ,_fe );};};_acd :=map[_fc .PdfObject ]bool {};_eab :=map[_fc .PdfObject ]bool {};for _ ,_ba :=range objects {switch _ecg :=_ba .(type ){case *_fc .PdfIndirectObject :switch _ddgf :=_ecg .PdfObject .(type ){case *_fc .PdfObjectDictionary :if _fa ,_bdg :=_fc .GetName (_ddgf .Get ("\u0054\u0079\u0070\u0065"));
!_bdg ||_fa .String ()!="\u0050\u0061\u0067\u0065"{continue ;};if _ddd ,_fb :=_fc .GetStream (_ddgf .Get ("\u0043\u006f\u006e\u0074\u0065\u006e\u0074\u0073"));_fb {_ff (_ddd );}else if _ecf ,_fef :=_fc .GetArray (_ddgf .Get ("\u0043\u006f\u006e\u0074\u0065\u006e\u0074\u0073"));
_fef {var _fgf []*_fc .PdfObjectStream ;for _ ,_gdb :=range _ecf .Elements (){if _fdd ,_ddgb :=_fc .GetStream (_gdb );_ddgb {_fgf =append (_fgf ,_fdd );};};if len (_fgf )> 0{var _afe _ed .Buffer ;for _ ,_cac :=range _fgf {if _gb ,_gfb :=_fc .DecodeStream (_cac );
_gfb ==nil {_afe .Write (_gb );};_acd [_cac ]=true ;};_bda ,_ccd :=_fc .MakeStream (_afe .Bytes (),_fc .NewFlateEncoder ());if _ccd !=nil {return nil ,_ccd ;};_eab [_bda ]=true ;_ddgf .Set ("\u0043\u006f\u006e\u0074\u0065\u006e\u0074\u0073",_bda );_ff (_bda );
};};};case *_fc .PdfObjectStream :if _bg ,_fbb :=_fc .GetName (_ecg .Get ("\u0054\u0079\u0070\u0065"));!_fbb ||_bg .String ()!="\u0058O\u0062\u006a\u0065\u0063\u0074"{continue ;};if _da ,_cd :=_fc .GetName (_ecg .Get ("\u0053u\u0062\u0074\u0079\u0070\u0065"));
!_cd ||_da .String ()!="\u0046\u006f\u0072\u006d"{continue ;};_ff (_ecg );};};for _ ,_bf :=range _fge {_abb =_eg (_bf );if _abb !=nil {return nil ,_abb ;};};_cf =nil ;for _ ,_bb :=range objects {if _acd [_bb ]{continue ;};_cf =append (_cf ,_bb );};for _fee :=range _eab {_cf =append (_cf ,_fee );
};return _cf ,nil ;};func _dea (_fdcb []_fc .PdfObject ,_bcdd map[_fc .PdfObject ]_fc .PdfObject ){if len (_bcdd )==0{return ;};for _dcbf ,_fcdf :=range _fdcb {if _ceee ,_ceeg :=_bcdd [_fcdf ];_ceeg {_fdcb [_dcbf ]=_ceee ;continue ;};_bcdd [_fcdf ]=_fcdf ;
switch _edda :=_fcdf .(type ){case *_fc .PdfObjectArray :_agcee :=make ([]_fc .PdfObject ,_edda .Len ());copy (_agcee ,_edda .Elements ());_dea (_agcee ,_bcdd );for _bdab ,_adgf :=range _agcee {_edda .Set (_bdab ,_adgf );};case *_fc .PdfObjectStreams :_dea (_edda .Elements (),_bcdd );
case *_fc .PdfObjectStream :_egad :=[]_fc .PdfObject {_edda .PdfObjectDictionary };_dea (_egad ,_bcdd );_edda .PdfObjectDictionary =_egad [0].(*_fc .PdfObjectDictionary );case *_fc .PdfObjectDictionary :_fcb :=_edda .Keys ();_bgd :=make ([]_fc .PdfObject ,len (_fcb ));
for _eafd ,_fcdd :=range _fcb {_bgd [_eafd ]=_edda .Get (_fcdd );};_dea (_bgd ,_bcdd );for _gfg ,_daab :=range _fcb {_edda .Set (_daab ,_bgd [_gfg ]);};case *_fc .PdfIndirectObject :_bcc :=[]_fc .PdfObject {_edda .PdfObject };_dea (_bcc ,_bcdd );_edda .PdfObject =_bcc [0];
};};};func _abc (_dfd *_fc .PdfObjectStream ,_ade []rune ,_cdfc []_g .GlyphIndex )error {_dfd ,_aea :=_fc .GetStream (_dfd );if !_aea {_d .Log .Debug ("\u0045\u006d\u0062\u0065\u0064\u0064\u0065\u0064\u0020\u0066\u006f\u006e\u0074\u0020\u006f\u0062\u006a\u0065c\u0074\u0020\u006e\u006f\u0074\u0020\u0066o\u0075\u006e\u0064\u0020\u002d\u002d\u0020\u0041\u0042\u004f\u0052T\u0020\u0073\u0075\u0062\u0073\u0065\u0074\u0074\u0069\u006e\u0067");
return _aa .New ("\u0066\u006f\u006e\u0074fi\u006c\u0065\u0032\u0020\u006e\u006f\u0074\u0020\u0066\u006f\u0075\u006e\u0064");};_de ,_aaff :=_fc .DecodeStream (_dfd );if _aaff !=nil {_d .Log .Debug ("\u0044\u0065c\u006f\u0064\u0065 \u0065\u0072\u0072\u006f\u0072\u003a\u0020\u0025\u0076",_aaff );
return _aaff ;};_bbd ,_aaff :=_g .Parse (_ed .NewReader (_de ));if _aaff !=nil {_d .Log .Debug ("\u0045\u0072\u0072\u006f\u0072\u0020\u0070\u0061\u0072\u0073\u0069n\u0067\u0020\u0025\u0064\u0020\u0062\u0079\u0074\u0065\u0020f\u006f\u006e\u0074",len (_dfd .Stream ));
return _aaff ;};_adg :=_cdfc ;if len (_ade )> 0{_bfgf :=_bbd .LookupRunes (_ade );_adg =append (_adg ,_bfgf ...);};_bbd ,_aaff =_bbd .SubsetKeepIndices (_adg );if _aaff !=nil {_d .Log .Debug ("\u0045R\u0052\u004f\u0052\u0020s\u0075\u0062\u0073\u0065\u0074t\u0069n\u0067 \u0066\u006f\u006e\u0074\u003a\u0020\u0025v",_aaff );
return _aaff ;};var _beg _ed .Buffer ;_aaff =_bbd .Write (&_beg );if _aaff !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004fR \u0057\u0072\u0069\u0074\u0069\u006e\u0067\u0020\u0066\u006f\u006e\u0074\u003a\u0020%\u0076",_aaff );return _aaff ;};if _beg .Len ()> len (_de ){_d .Log .Debug ("\u0052\u0065-\u0077\u0072\u0069\u0074\u0074\u0065\u006e\u0020\u0066\u006f\u006e\u0074\u0020\u0069\u0073\u0020\u006c\u0061\u0072\u0067\u0065\u0072\u0020\u0074\u0068\u0061\u006e\u0020\u006f\u0072\u0069\u0067\u0069\u006e\u0061\u006c\u0020\u002d\u0020\u0073\u006b\u0069\u0070");
return nil ;};_gbbg ,_aaff :=_fc .MakeStream (_beg .Bytes (),_fc .NewFlateEncoder ());if _aaff !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004fR \u0057\u0072\u0069\u0074\u0069\u006e\u0067\u0020\u0066\u006f\u006e\u0074\u003a\u0020%\u0076",_aaff );return _aaff ;
};*_dfd =*_gbbg ;_dfd .Set ("\u004ce\u006e\u0067\u0074\u0068\u0031",_fc .MakeInteger (int64 (_beg .Len ())));return nil ;};

// Optimize optimizes PDF objects to decrease PDF size.
func (_afa *ImagePPI )Optimize (objects []_fc .PdfObject )(_faf []_fc .PdfObject ,_faa error ){if _afa .ImageUpperPPI <=0{return objects ,nil ;};_cff :=_cgff (objects );if len (_cff )==0{return objects ,nil ;};_bfcb :=make (map[_fc .PdfObject ]struct{});
for _ ,_gbdc :=range _cff {_daeb :=_gbdc .Stream .PdfObjectDictionary .Get ("\u0053\u004d\u0061s\u006b");_bfcb [_daeb ]=struct{}{};};_caff :=make (map[*_fc .PdfObjectStream ]*imageInfo );for _ ,_dfbb :=range _cff {_caff [_dfbb .Stream ]=_dfbb ;};var _egdgd *_fc .PdfObjectDictionary ;
for _ ,_febg :=range objects {if _gbdff ,_eaaa :=_fc .GetDict (_febg );_egdgd ==nil &&_eaaa {if _bbab ,_febb :=_fc .GetName (_gbdff .Get ("\u0054\u0079\u0070\u0065"));_febb &&*_bbab =="\u0043a\u0074\u0061\u006c\u006f\u0067"{_egdgd =_gbdff ;};};};if _egdgd ==nil {return objects ,nil ;
};_eag ,_gaff :=_fc .GetDict (_egdgd .Get ("\u0050\u0061\u0067e\u0073"));if !_gaff {return objects ,nil ;};_ged ,_deed :=_fc .GetArray (_eag .Get ("\u004b\u0069\u0064\u0073"));if !_deed {return objects ,nil ;};for _ ,_eecc :=range _ged .Elements (){_eggff :=make (map[string ]*imageInfo );
_babg ,_bgfe :=_fc .GetDict (_eecc );if !_bgfe {continue ;};_fbdd ,_ :=_caae (_babg .Get ("\u0043\u006f\u006e\u0074\u0065\u006e\u0074\u0073"));if len (_fbdd )==0{continue ;};_gbf ,_dbef :=_fc .GetDict (_babg .Get ("\u0052e\u0073\u006f\u0075\u0072\u0063\u0065s"));
if !_dbef {continue ;};_dfba ,_cceg :=_dga .NewPdfPageResourcesFromDict (_gbf );if _cceg !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u0020\u0070\u0061\u0072\u0073\u0069\u006e\u0067\u0020\u0072\u0065\u0073\u006f\u0075\u0072\u0063\u0065\u0073\u0020-\u0020\u0069\u0067\u006e\u006fr\u0069\u006eg\u003a\u0020\u0025\u0076",_cceg );
continue ;};_ecgb ,_fdde :=_fc .GetDict (_gbf .Get ("\u0058O\u0062\u006a\u0065\u0063\u0074"));if !_fdde {continue ;};_adc :=_ecgb .Keys ();for _ ,_dfe :=range _adc {if _abd ,_fadc :=_fc .GetStream (_ecgb .Get (_dfe ));_fadc {if _cecae ,_fadg :=_caff [_abd ];
_fadg {_eggff [string (_dfe )]=_cecae ;};};};_fadd :=_fd .NewContentStreamParser (_fbdd );_cfba ,_cceg :=_fadd .Parse ();if _cceg !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u003a\u0020\u0025\u002b\u0076",_cceg );continue ;};_gecf :=_fd .NewContentStreamProcessor (*_cfba );
_gecf .AddHandler (_fd .HandlerConditionEnumAllOperands ,"",func (_gdcd *_fd .ContentStreamOperation ,_cbba _fd .GraphicsState ,_fabd *_dga .PdfPageResources )error {switch _gdcd .Operand {case "\u0044\u006f":if len (_gdcd .Params )!=1{_d .Log .Debug ("E\u0052\u0052\u004f\u0052\u003a\u0020\u0049\u0067\u006e\u006f\u0072\u0069\u006e\u0067\u0020\u0044\u006f\u0020w\u0069\u0074\u0068\u0020\u006c\u0065\u006e\u0028\u0070\u0061ra\u006d\u0073\u0029 \u0021=\u0020\u0031");
return nil ;};_bfaa ,_dfbaf :=_fc .GetName (_gdcd .Params [0]);if !_dfbaf {_d .Log .Debug ("\u0045\u0052\u0052O\u0052\u003a\u0020\u0049\u0067\u006e\u006f\u0072\u0069\u006e\u0067\u0020\u0044\u006f\u0020\u0077\u0069\u0074\u0068\u0020\u006e\u006f\u006e\u0020\u004e\u0061\u006d\u0065\u0020p\u0061\u0072\u0061\u006d\u0065\u0074\u0065\u0072");
return nil ;};if _cbbc ,_ebaa :=_eggff [string (*_bfaa )];_ebaa {_bgae :=_cbba .CTM .ScalingFactorX ();_cfga :=_cbba .CTM .ScalingFactorY ();_bea ,_eabe :=_bgae /72.0,_cfga /72.0;_eggb ,_afg :=float64 (_cbbc .Width )/_bea ,float64 (_cbbc .Height )/_eabe ;
if _bea ==0||_eabe ==0{_eggb =72.0;_afg =72.0;};_cbbc .PPI =_e .Max (_cbbc .PPI ,_eggb );_cbbc .PPI =_e .Max (_cbbc .PPI ,_afg );};};return nil ;});_cceg =_gecf .Process (_dfba );if _cceg !=nil {_d .Log .Debug ("E\u0052\u0052\u004f\u0052 p\u0072o\u0063\u0065\u0073\u0073\u0069n\u0067\u003a\u0020\u0025\u002b\u0076",_cceg );
continue ;};};for _ ,_fcfg :=range _cff {if _ ,_dece :=_bfcb [_fcfg .Stream ];_dece {continue ;};if _fcfg .PPI <=_afa .ImageUpperPPI {continue ;};_bgc ,_befg :=_dga .NewXObjectImageFromStream (_fcfg .Stream );if _befg !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u003a\u0020\u0025\u002b\u0076",_befg );
continue ;};var _gcad imageModifications ;_gcad .Scale =_afa .ImageUpperPPI /_fcfg .PPI ;if _fcfg .BitsPerComponent ==1&&_fcfg .ColorComponents ==1{_gea :=_e .Round (_fcfg .PPI /_afa .ImageUpperPPI );_gddd :=_db .NextPowerOf2 (uint (_gea ));if _db .InDelta (float64 (_gddd ),1/_gcad .Scale ,0.3){_gcad .Scale =float64 (1)/float64 (_gddd );
};if _ ,_beaf :=_bgc .Filter .(*_fc .JBIG2Encoder );!_beaf {_gcad .Encoding =_fc .NewJBIG2Encoder ();};};if _befg =_ded (_bgc ,_gcad );_befg !=nil {_d .Log .Debug ("\u0045\u0072\u0072\u006f\u0072 \u0073\u0063\u0061\u006c\u0065\u0020\u0069\u006d\u0061\u0067\u0065\u0020\u006be\u0065\u0070\u0020\u006f\u0072\u0069\u0067\u0069\u006e\u0061\u006c\u0020\u0069\u006d\u0061\u0067\u0065\u003a\u0020\u0025\u0073",_befg );
continue ;};_gcad .Encoding =nil ;if _fdb ,_cege :=_fc .GetStream (_fcfg .Stream .PdfObjectDictionary .Get ("\u0053\u004d\u0061s\u006b"));_cege {_gege ,_fbea :=_dga .NewXObjectImageFromStream (_fdb );if _fbea !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u003a\u0020\u0025\u002b\u0076",_fbea );
continue ;};if _fbea =_ded (_gege ,_gcad );_fbea !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u003a\u0020\u0025\u002b\u0076",_fbea );continue ;};};};return objects ,nil ;};func _cgff (_ebe []_fc .PdfObject )[]*imageInfo {_gdf :=_fc .PdfObjectName ("\u0053u\u0062\u0074\u0079\u0070\u0065");
_eee :=make (map[*_fc .PdfObjectStream ]struct{});var _fdc []*imageInfo ;for _ ,_dega :=range _ebe {_aafc ,_gcda :=_fc .GetStream (_dega );if !_gcda {continue ;};if _ ,_baaf :=_eee [_aafc ];_baaf {continue ;};_eee [_aafc ]=struct{}{};_adb :=_aafc .PdfObjectDictionary .Get (_gdf );
_dab ,_gcda :=_fc .GetName (_adb );if !_gcda ||string (*_dab )!="\u0049\u006d\u0061g\u0065"{continue ;};_gcaa :=&imageInfo {Stream :_aafc ,BitsPerComponent :8};if _cda ,_gffa :=_fc .GetIntVal (_aafc .Get ("\u0042\u0069t\u0073\u0050\u0065r\u0043\u006f\u006d\u0070\u006f\u006e\u0065\u006e\u0074"));
_gffa {_gcaa .BitsPerComponent =_cda ;};if _cebe ,_gegd :=_fc .GetIntVal (_aafc .Get ("\u0057\u0069\u0064t\u0068"));_gegd {_gcaa .Width =_cebe ;};if _bdge ,_bca :=_fc .GetIntVal (_aafc .Get ("\u0048\u0065\u0069\u0067\u0068\u0074"));_bca {_gcaa .Height =_bdge ;
};_bgg ,_egga :=_dga .NewPdfColorspaceFromPdfObject (_aafc .Get ("\u0043\u006f\u006c\u006f\u0072\u0053\u0070\u0061\u0063\u0065"));if _egga !=nil {_d .Log .Debug ("\u0045R\u0052\u004f\u0052\u003a\u0020\u0025v",_egga );continue ;};if _bgg ==nil {_gaab ,_cee :=_fc .GetName (_aafc .Get ("\u0046\u0069\u006c\u0074\u0065\u0072"));
if _cee {switch _gaab .String (){case "\u0043\u0043\u0049\u0054\u0054\u0046\u0061\u0078\u0044e\u0063\u006f\u0064\u0065","J\u0042\u0049\u0047\u0032\u0044\u0065\u0063\u006f\u0064\u0065":_bgg =_dga .NewPdfColorspaceDeviceGray ();_gcaa .BitsPerComponent =1;
};};};switch _bcag :=_bgg .(type ){case *_dga .PdfColorspaceDeviceRGB :_gcaa .ColorComponents =3;case *_dga .PdfColorspaceDeviceGray :_gcaa .ColorComponents =1;default:_d .Log .Debug ("\u004f\u0070\u0074\u0069\u006d\u0069\u007aa\u0074\u0069\u006fn\u0020\u0069\u0073 \u006e\u006ft\u0020\u0073\u0075\u0070\u0070\u006fr\u0074ed\u0020\u0066\u006f\u0072\u0020\u0063\u006f\u006c\u006f\u0072\u0020\u0073\u0070\u0061\u0063\u0065\u0020\u0025\u0054\u0020\u002d\u0020\u0073\u006b\u0069\u0070",_bcag );
continue ;};_fdc =append (_fdc ,_gcaa );};return _fdc ;};

// Optimize optimizes PDF objects to decrease PDF size.
func (_cbc *CombineDuplicateDirectObjects )Optimize (objects []_fc .PdfObject )(_bab []_fc .PdfObject ,_ggdg error ){_fgfg (objects );_fffg :=make (map[string ][]*_fc .PdfObjectDictionary );var _dddb func (_fce *_fc .PdfObjectDictionary );_dddb =func (_fbc *_fc .PdfObjectDictionary ){for _ ,_agfg :=range _fbc .Keys (){_dbde :=_fbc .Get (_agfg );
if _fcfa ,_gcd :=_dbde .(*_fc .PdfObjectDictionary );_gcd {if _beec :=_fcfa .Keys ();len (_beec )==0{continue ;};_cgg :=_c .New ();_cgg .Write (_fcfa .Write ());_gfbg :=string (_cgg .Sum (nil ));_fffg [_gfbg ]=append (_fffg [_gfbg ],_fcfa );_dddb (_fcfa );
};};};for _ ,_bbda :=range objects {_cab ,_cgab :=_bbda .(*_fc .PdfIndirectObject );if !_cgab {continue ;};if _gcf ,_geb :=_cab .PdfObject .(*_fc .PdfObjectDictionary );_geb {_dddb (_gcf );};};_edde :=make ([]_fc .PdfObject ,0,len (_fffg ));_geg :=make (map[_fc .PdfObject ]_fc .PdfObject );
for _ ,_fbd :=range _fffg {if len (_fbd )< 2{continue ;};_dfg :=_fc .MakeDict ();_dfg .Merge (_fbd [0]);_gaf :=_fc .MakeIndirectObject (_dfg );_edde =append (_edde ,_gaf );for _ffff :=0;_ffff < len (_fbd );_ffff ++{_bgb :=_fbd [_ffff ];_geg [_bgb ]=_gaf ;
};};_bab =make ([]_fc .PdfObject ,len (objects ));copy (_bab ,objects );_bab =append (_edde ,_bab ...);_dea (_bab ,_geg );return _bab ,nil ;};

// ObjectStreams groups PDF objects to object streams.
// It implements interface model.Optimizer.
type ObjectStreams struct{};func _age (_efb _fc .PdfObject )[]content {if _efb ==nil {return nil ;};_cfb ,_gec :=_fc .GetArray (_efb );if !_gec {_d .Log .Debug ("\u0041\u006e\u006e\u006fts\u0020\u006e\u006f\u0074\u0020\u0061\u006e\u0020\u0061\u0072\u0072\u0061\u0079");
return nil ;};var _gga []content ;for _ ,_ee :=range _cfb .Elements (){_aae ,_bdbd :=_fc .GetDict (_ee );if !_bdbd {_d .Log .Debug ("I\u0067\u006e\u006f\u0072\u0069\u006eg\u0020\u006e\u006f\u006e\u002d\u0064i\u0063\u0074\u0020\u0065\u006c\u0065\u006de\u006e\u0074\u0020\u0069\u006e\u0020\u0041\u006e\u006e\u006ft\u0073");
continue ;};_deb ,_bdbd :=_fc .GetDict (_aae .Get ("\u0041\u0050"));if !_bdbd {_d .Log .Debug ("\u004e\u006f\u0020\u0041P \u0065\u006e\u0074\u0072\u0079\u0020\u002d\u0020\u0073\u006b\u0069\u0070\u0070\u0069n\u0067");continue ;};_ccg :=_fc .TraceToDirectObject (_deb .Get ("\u004e"));
if _ccg ==nil {_d .Log .Debug ("N\u006f\u0020\u004e\u0020en\u0074r\u0079\u0020\u002d\u0020\u0073k\u0069\u0070\u0070\u0069\u006e\u0067");continue ;};var _bge *_fc .PdfObjectStream ;switch _eabb :=_ccg .(type ){case *_fc .PdfObjectDictionary :_efa ,_dc :=_fc .GetName (_aae .Get ("\u0041\u0053"));
if !_dc {_d .Log .Debug ("\u004e\u006f\u0020\u0041S \u0065\u006e\u0074\u0072\u0079\u0020\u002d\u0020\u0073\u006b\u0069\u0070\u0070\u0069n\u0067");continue ;};_bge ,_dc =_fc .GetStream (_eabb .Get (*_efa ));if !_dc {_d .Log .Debug ("\u0046o\u0072\u006d\u0020\u006eo\u0074\u0020\u0066\u006f\u0075n\u0064 \u002d \u0073\u006b\u0069\u0070\u0070\u0069\u006eg");
continue ;};case *_fc .PdfObjectStream :_bge =_eabb ;};if _bge ==nil {_d .Log .Debug ("\u0046\u006f\u0072m\u0020\u006e\u006f\u0074 \u0066\u006f\u0075\u006e\u0064\u0020\u0028n\u0069\u006c\u0029\u0020\u002d\u0020\u0073\u006b\u0069\u0070\u0070\u0069\u006e\u0067");
continue ;};_gab ,_begd :=_dga .NewXObjectFormFromStream (_bge );if _begd !=nil {_d .Log .Debug ("\u0045\u0072\u0072\u006f\u0072\u0020l\u006f\u0061\u0064\u0069\u006e\u0067\u0020\u0066\u006f\u0072\u006d\u003a\u0020%\u0076\u0020\u002d\u0020\u0069\u0067\u006eo\u0072\u0069\u006e\u0067",_begd );
continue ;};_cfa ,_begd :=_gab .GetContentStream ();if _begd !=nil {_d .Log .Debug ("E\u0072\u0072\u006f\u0072\u0020\u0064e\u0063\u006f\u0064\u0069\u006e\u0067\u0020\u0063\u006fn\u0074\u0065\u006et\u0073:\u0020\u0025\u0076",_begd );continue ;};_gga =append (_gga ,content {_bdac :string (_cfa ),_gac :_gab .Resources });
};return _gga ;};func _efd (_dgd *_fc .PdfObjectDictionary )[]string {_bdae :=[]string {};for _ ,_ebg :=range _dgd .Keys (){_bdae =append (_bdae ,_ebg .String ());};return _bdae ;};

// Optimize optimizes PDF objects to decrease PDF size.
func (_ggbd *Image )Optimize (objects []_fc .PdfObject )(_bbc []_fc .PdfObject ,_cece error ){if _ggbd .ImageQuality <=0{return objects ,nil ;};_bfdf :=_cgff (objects );if len (_bfdf )==0{return objects ,nil ;};_dbf :=make (map[_fc .PdfObject ]_fc .PdfObject );
_dbe :=make (map[_fc .PdfObject ]struct{});for _ ,_dcb :=range _bfdf {_fadf :=_dcb .Stream .Get ("\u0053\u004d\u0061s\u006b");_dbe [_fadf ]=struct{}{};};for _bggc ,_efg :=range _bfdf {_aacb :=_efg .Stream ;if _ ,_ddaee :=_dbe [_aacb ];_ddaee {continue ;
};_ceac ,_bfe :=_dga .NewXObjectImageFromStream (_aacb );if _bfe !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u003a\u0020\u0025\u002b\u0076",_bfe );continue ;};switch _ceac .Filter .(type ){case *_fc .JBIG2Encoder :continue ;case *_fc .CCITTFaxEncoder :continue ;
};_bce ,_bfe :=_ceac .ToImage ();if _bfe !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u003a\u0020\u0025\u002b\u0076",_bfe );continue ;};_bdga :=_fc .NewDCTEncoder ();_bdga .ColorComponents =_bce .ColorComponents ;_bdga .Quality =_ggbd .ImageQuality ;
_bdga .BitsPerComponent =_efg .BitsPerComponent ;_bdga .Width =_efg .Width ;_bdga .Height =_efg .Height ;_ecfe ,_bfe :=_bdga .EncodeBytes (_bce .Data );if _bfe !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u003a\u0020\u0025\u002b\u0076",_bfe );
continue ;};var _ead _fc .StreamEncoder ;_ead =_bdga ;{_ccff :=_fc .NewFlateEncoder ();_dfgb :=_fc .NewMultiEncoder ();_dfgb .AddEncoder (_ccff );_dfgb .AddEncoder (_bdga );_dacd ,_agae :=_dfgb .EncodeBytes (_bce .Data );if _agae !=nil {_d .Log .Debug ("\u0045\u0052\u0052\u004f\u0052\u003a\u0020\u0025\u002b\u0076",_agae );
continue ;};if len (_dacd )< len (_ecfe ){_d .Log .Trace ("\u004d\u0075\u006c\u0074\u0069\u0020\u0065\u006e\u0063\u0020\u0069\u006d\u0070\u0072\u006f\u0076\u0065\u0073\u003a\u0020\u0025\u0064\u0020\u0074o\u0020\u0025\u0064\u0020\u0028o\u0072\u0069g\u0020\u0025\u0064\u0029",len (_ecfe ),len (_dacd ),len (_aacb .Stream ));
_ecfe =_dacd ;_ead =_dfgb ;};};_aabdg :=len (_aacb .Stream );if _aabdg < len (_ecfe ){continue ;};_ccfg :=&_fc .PdfObjectStream {Stream :_ecfe };_ccfg .PdfObjectReference =_aacb .PdfObjectReference ;_ccfg .PdfObjectDictionary =_fc .MakeDict ();_ccfg .Merge (_aacb .PdfObjectDictionary );
_ccfg .Merge (_ead .MakeStreamDict ());_ccfg .Set ("\u004c\u0065\u006e\u0067\u0074\u0068",_fc .MakeInteger (int64 (len (_ecfe ))));_dbf [_aacb ]=_ccfg ;_bfdf [_bggc ].Stream =_ccfg ;};_bbc =make ([]_fc .PdfObject ,len (objects ));copy (_bbc ,objects );
_dea (_bbc ,_dbf );return _bbc ,nil ;};

// Append appends optimizers to the chain.
func (_ga *Chain )Append (optimizers ..._dga .Optimizer ){_ga ._ae =append (_ga ._ae ,optimizers ...)};func _caae (_cgfd _fc .PdfObject )(_fefd string ,_bcbf []_fc .PdfObject ){var _eabeb _ed .Buffer ;switch _dgfe :=_cgfd .(type ){case *_fc .PdfIndirectObject :_bcbf =append (_bcbf ,_dgfe );
_cgfd =_dgfe .PdfObject ;};switch _gead :=_cgfd .(type ){case *_fc .PdfObjectStream :if _aafce ,_fbaa :=_fc .DecodeStream (_gead );_fbaa ==nil {_eabeb .Write (_aafce );_bcbf =append (_bcbf ,_gead );};case *_fc .PdfObjectArray :for _ ,_aafa :=range _gead .Elements (){switch _bfb :=_aafa .(type ){case *_fc .PdfObjectStream :if _baag ,_gafb :=_fc .DecodeStream (_bfb );
_gafb ==nil {_eabeb .Write (_baag );_bcbf =append (_bcbf ,_bfb );};};};};return _eabeb .String (),_bcbf ;};func _fgfg (_abbb []_fc .PdfObject ){for _ffce ,_dfbf :=range _abbb {switch _gecb :=_dfbf .(type ){case *_fc .PdfIndirectObject :_gecb .ObjectNumber =int64 (_ffce +1);
_gecb .GenerationNumber =0;case *_fc .PdfObjectStream :_gecb .ObjectNumber =int64 (_ffce +1);_gecb .GenerationNumber =0;case *_fc .PdfObjectStreams :_gecb .ObjectNumber =int64 (_ffce +1);_gecb .GenerationNumber =0;};};};

// Optimize optimizes PDF objects to decrease PDF size.
func (_cea *CompressStreams )Optimize (objects []_fc .PdfObject )(_aecfe []_fc .PdfObject ,_eggf error ){_aecfe =make ([]_fc .PdfObject ,len (objects ));copy (_aecfe ,objects );for _ ,_egdb :=range objects {_bff ,_bba :=_fc .GetStream (_egdb );if !_bba {continue ;
};if _efcb :=_bff .Get ("\u0046\u0069\u006c\u0074\u0065\u0072");_efcb !=nil {if _ ,_cce :=_fc .GetName (_efcb );_cce {continue ;};if _ddbb ,_begdb :=_fc .GetArray (_efcb );_begdb &&_ddbb .Len ()> 0{continue ;};};_gagd :=_fc .NewFlateEncoder ();var _dcg []byte ;
_dcg ,_eggf =_gagd .EncodeBytes (_bff .Stream );if _eggf !=nil {return _aecfe ,_eggf ;};_gccf :=_gagd .MakeStreamDict ();if len (_dcg )+len (_gccf .Write ())< len (_bff .Stream ){_bff .Stream =_dcg ;_bff .PdfObjectDictionary .Merge (_gccf );_bff .PdfObjectDictionary .Set ("\u004c\u0065\u006e\u0067\u0074\u0068",_fc .MakeInteger (int64 (len (_bff .Stream ))));
};};return _aecfe ,nil ;};func _ded (_defg *_dga .XObjectImage ,_dcca imageModifications )error {_bbac ,_adbf :=_defg .ToImage ();if _adbf !=nil {return _adbf ;};if _dcca .Scale !=0{_bbac ,_adbf =_bgea (_bbac ,_dcca .Scale );if _adbf !=nil {return _adbf ;
};};if _dcca .Encoding !=nil {_defg .Filter =_dcca .Encoding ;};_defg .Decode =nil ;switch _gfab :=_defg .Filter .(type ){case *_fc .FlateEncoder :if _gfab .Predictor !=1&&_gfab .Predictor !=11{_gfab .Predictor =1;};};if _adbf =_defg .SetImage (_bbac ,nil );
_adbf !=nil {_d .Log .Debug ("\u0045\u0072\u0072or\u0020\u0073\u0065\u0074\u0074\u0069\u006e\u0067\u0020\u0069\u006d\u0061\u0067\u0065\u003a\u0020\u0025\u0076",_adbf );return _adbf ;};_defg .ToPdfObject ();return nil ;};

// CombineDuplicateStreams combines duplicated streams by its data hash.
// It implements interface model.Optimizer.
type CombineDuplicateStreams struct{};type content struct{_bdac string ;_gac *_dga .PdfPageResources ;};

// Optimize optimizes PDF objects to decrease PDF size.
func (_ef *Chain )Optimize (objects []_fc .PdfObject )(_aab []_fc .PdfObject ,_cc error ){_eb :=objects ;for _ ,_ac :=range _ef ._ae {_be ,_dda :=_ac .Optimize (_eb );if _dda !=nil {_d .Log .Debug ("\u0045\u0052\u0052OR\u0020\u004f\u0070\u0074\u0069\u006d\u0069\u007a\u0061\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u002b\u0076",_dda );
continue ;};_eb =_be ;};return _eb ,nil ;};

// Image optimizes images by rewrite images into JPEG format with quality equals to ImageQuality.
// TODO(a5i): Add support for inline images.
// It implements interface model.Optimizer.
type Image struct{ImageQuality int ;};func _bgea (_dcgb *_dga .Image ,_eda float64 )(*_dga .Image ,error ){_cgdg ,_agce :=_dcgb .ToGoImage ();if _agce !=nil {return nil ,_agce ;};var _eecg _db .Image ;_ceca ,_dabg :=_cgdg .(*_db .Monochrome );if _dabg {if _agce =_ceca .ResolveDecode ();
_agce !=nil {return nil ,_agce ;};_eecg ,_agce =_ceca .Scale (_eda );if _agce !=nil {return nil ,_agce ;};}else {_gdg :=int (_e .RoundToEven (float64 (_dcgb .Width )*_eda ));_gbea :=int (_e .RoundToEven (float64 (_dcgb .Height )*_eda ));_eecg ,_agce =_db .NewImage (_gdg ,_gbea ,int (_dcgb .BitsPerComponent ),_dcgb .ColorComponents ,nil ,nil ,nil );
if _agce !=nil {return nil ,_agce ;};_a .CatmullRom .Scale (_eecg ,_eecg .Bounds (),_cgdg ,_cgdg .Bounds (),_a .Over ,&_a .Options {});};_eebf :=_eecg .Base ();_dae :=&_dga .Image {Width :int64 (_eebf .Width ),Height :int64 (_eebf .Height ),BitsPerComponent :int64 (_eebf .BitsPerComponent ),ColorComponents :_eebf .ColorComponents ,Data :_eebf .Data };
_dae .SetDecode (_eebf .Decode );_dae .SetAlpha (_eebf .Alpha );return _dae ,nil ;};type objectStructure struct{_bcde *_fc .PdfObjectDictionary ;_eaabd *_fc .PdfObjectDictionary ;_agfd []*_fc .PdfIndirectObject ;};

// Optimize optimizes PDF objects to decrease PDF size.
func (_fgeb *CombineDuplicateStreams )Optimize (objects []_fc .PdfObject )(_dgg []_fc .PdfObject ,_gffd error ){_cbcg :=make (map[_fc .PdfObject ]_fc .PdfObject );_adaf :=make (map[_fc .PdfObject ]struct{});_dgdd :=make (map[string ][]*_fc .PdfObjectStream );
for _ ,_ece :=range objects {if _dfff ,_dge :=_ece .(*_fc .PdfObjectStream );_dge {_cdb :=_c .New ();_cdb .Write (_dfff .Stream );_cdb .Write (_dfff .PdfObjectDictionary .Write ());_gcg :=string (_cdb .Sum (nil ));_dgdd [_gcg ]=append (_dgdd [_gcg ],_dfff );
};};for _ ,_gge :=range _dgdd {if len (_gge )< 2{continue ;};_agab :=_gge [0];for _bef :=1;_bef < len (_gge );_bef ++{_faec :=_gge [_bef ];_cbcg [_faec ]=_agab ;_adaf [_faec ]=struct{}{};};};_dgg =make ([]_fc .PdfObject ,0,len (objects )-len (_adaf ));
for _ ,_bddb :=range objects {if _ ,_fbcd :=_adaf [_bddb ];_fbcd {continue ;};_dgg =append (_dgg ,_bddb );};_dea (_dgg ,_cbcg );return _dgg ,nil ;};

// CompressStreams compresses uncompressed streams.
// It implements interface model.Optimizer.
type CompressStreams struct{};

// CombineDuplicateDirectObjects combines duplicated direct objects by its data hash.
// It implements interface model.Optimizer.
type CombineDuplicateDirectObjects struct{};func _bfec (_ceec []_fc .PdfObject )objectStructure {_daad :=objectStructure {};_eebc :=false ;for _ ,_afdb :=range _ceec {switch _cgga :=_afdb .(type ){case *_fc .PdfIndirectObject :_debf ,_acca :=_fc .GetDict (_cgga );
if !_acca {continue ;};_bcdb ,_acca :=_fc .GetName (_debf .Get ("\u0054\u0079\u0070\u0065"));if !_acca {continue ;};switch _bcdb .String (){case "\u0043a\u0074\u0061\u006c\u006f\u0067":_daad ._bcde =_debf ;_eebc =true ;};};if _eebc {break ;};};if !_eebc {return _daad ;
};_ggaa ,_ecfec :=_fc .GetDict (_daad ._bcde .Get ("\u0050\u0061\u0067e\u0073"));if !_ecfec {return _daad ;};_daad ._eaabd =_ggaa ;_ggg ,_ecfec :=_fc .GetArray (_ggaa .Get ("\u004b\u0069\u0064\u0073"));if !_ecfec {return _daad ;};for _ ,_dag :=range _ggg .Elements (){_bad ,_gda :=_fc .GetIndirect (_dag );
if !_gda {break ;};_daad ._agfd =append (_daad ._agfd ,_bad );};return _daad ;};

// GetOptimizers gets the list of optimizers in chain `c`.
func (_cb *Chain )GetOptimizers ()[]_dga .Optimizer {return _cb ._ae };func _ebb (_eaf []_fc .PdfObject )(map[_fc .PdfObject ]struct{},error ){_aabc :=_bfec (_eaf );_aga :=_aabc ._agfd ;_gfac :=make (map[_fc .PdfObject ]struct{});_eed :=_eacd (_aga );for _ ,_aba :=range _aga {_bgf ,_gbdf :=_fc .GetDict (_aba .PdfObject );
if !_gbdf {continue ;};_aecf ,_gbdf :=_fc .GetDict (_bgf .Get ("\u0052e\u0073\u006f\u0075\u0072\u0063\u0065s"));if !_gbdf {continue ;};_bfc :=_eed ["\u0058O\u0062\u006a\u0065\u0063\u0074"];_dfa ,_gbdf :=_fc .GetDict (_aecf .Get ("\u0058O\u0062\u006a\u0065\u0063\u0074"));
if _gbdf {_efcg :=_efd (_dfa );for _ ,_abaa :=range _efcg {if _beb (_abaa ,_bfc ){continue ;};_dec :=*_fc .MakeName (_abaa );_dff :=_dfa .Get (_dec );_gfac [_dff ]=struct{}{};_dfa .Remove (_dec );_fgcg :=_adgb (_dff ,_gfac );if _fgcg !=nil {_d .Log .Debug ("\u0066\u0061\u0069\u006ce\u0064\u0020\u0074\u006f\u0020\u0074\u0072\u0061\u0076\u0065r\u0073e\u0020\u006f\u0062\u006a\u0065\u0063\u0074 \u0025\u0076",_dff );
};};};_gca ,_gbdf :=_fc .GetDict (_aecf .Get ("\u0046\u006f\u006e\u0074"));_eec :=_eed ["\u0046\u006f\u006e\u0074"];if _gbdf {_aeaa :=_efd (_gca );for _ ,_dgb :=range _aeaa {if _beb (_dgb ,_eec ){continue ;};_fedd :=*_fc .MakeName (_dgb );_agf :=_gca .Get (_fedd );
_gfac [_agf ]=struct{}{};_gca .Remove (_fedd );_fcg :=_adgb (_agf ,_gfac );if _fcg !=nil {_d .Log .Debug ("\u0046\u0061i\u006c\u0065\u0064\u0020\u0074\u006f\u0020\u0074\u0072\u0061\u0076\u0065\u0072\u0073\u0065\u0020\u006f\u0062\u006a\u0065\u0063\u0074 %\u0076\u000a",_agf );
};};};_aca ,_gbdf :=_fc .GetDict (_aecf .Get ("\u0045x\u0074\u0047\u0053\u0074\u0061\u0074e"));if _gbdf {_fba :=_efd (_aca );_gbbe :=_eed ["\u0045x\u0074\u0047\u0053\u0074\u0061\u0074e"];for _ ,_bcb :=range _fba {if _beb (_bcb ,_gbbe ){continue ;};_gfae :=*_fc .MakeName (_bcb );
_ggb :=_aca .Get (_gfae );_gfac [_ggb ]=struct{}{};_aca .Remove (_gfae );_bdbf :=_adgb (_ggb ,_gfac );if _bdbf !=nil {_d .Log .Debug ("\u0066\u0061i\u006c\u0065\u0064\u0020\u0074\u006f\u0020\u0074\u0072\u0061\u0076\u0065\u0072\u0073\u0065\u0020\u006f\u0062\u006a\u0065\u0063\u0074 %\u0076\u000a",_ggb );
};};};};return _gfac ,nil ;};func _beb (_ccda string ,_cga []string )bool {for _ ,_dfc :=range _cga {if _ccda ==_dfc {return true ;};};return false ;};

// Chain allows to use sequence of optimizers.
// It implements interface model.Optimizer.
type Chain struct{_ae []_dga .Optimizer };